<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Anota√ß√µes e Desenhos para iPad com Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {background: #f2f2f2; font-family: Arial, Helvetica, sans-serif; margin: 0;}
    .container {max-width: 700px; margin: 30px auto; background: #fff; border-radius: 15px; box-shadow: 0 4px 16px #0002; padding: 20px;}
    h1 {text-align:center; font-size: 1.5em;}
    #notes {width: 100%; height: 100px; border-radius: 8px; border: 1px solid #bbb; margin-bottom: 16px; font-size: 1.1em; padding: 10px; box-sizing: border-box;}
    #drawWrap {border: 1px solid #bbb; border-radius: 8px; margin-bottom: 12px; overflow: hidden; background: #fff; touch-action: none;}
    #draw {display: block; width: 100%; height: 300px; background: #fff; touch-action: none;}
    .toolbar {display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; align-items: center;}
    .toolbar label {font-size: 0.95em; margin-right: 4px;}
    .toolbar input[type=range] {vertical-align: middle;}
    .toolbar input[type=color] {width: 36px; height: 36px; border: none; background: none;}
    .toolbar button {border: none; border-radius: 6px; background: #eee; padding: 7px 14px; font-size: 1em; cursor: pointer;}
    .toolbar button:hover {background: #ddd;}
    .actions {display: flex; justify-content: center; gap: 12px; margin-top: 16px;}
    .actions button {background: #4facfe; color: #fff; font-weight: bold;}
    .actions button:hover {background: #0073e6;}
    #loginBox {max-width: 300px; margin: 70px auto 0 auto; background: #fff; padding: 30px 20px; border-radius: 10px; box-shadow: 0 2px 8px #0001;}
    #loginBox input {width: 100%; margin-bottom: 12px; padding: 10px; border-radius: 6px; border: 1px solid #bbb;}
    #loginBox button {width: 100%; padding: 10px; border-radius: 6px; border: none; background: #4facfe; color: #fff; font-size: 1em;}
    #loginBox button:hover {background: #0073e6;}
    #logoutBtn {float:right; background: #d9534f; color: #fff; font-weight:bold; border:none; border-radius:6px; padding:7px 18px; cursor:pointer;}
    #logoutBtn:hover {background: #b52b27;}
    .welcome {text-align:right; color:#888; margin-bottom:10px;}
    @media (max-width: 600px) {.container {padding: 6px;} #draw {height: 180px;}}
  </style>
</head>
<body>
  <div id="loginBox" style="display:none;">
    <h2 style="text-align:center;">Login</h2>
    <input type="text" id="user" placeholder="Usu√°rio" autocomplete="username">
    <input type="password" id="pass" placeholder="Senha" autocomplete="current-password">
    <button onclick="login()">Entrar</button>
    <button style="background:#28a745; margin-top:10px;" onclick="register()">Registrar Novo Usu√°rio</button>
    <div id="loginMsg" style="color:#d9534f;margin-top:12px;text-align:center;"></div>
  </div>
  <div class="container" id="mainApp" style="display:none;">
    <div class="welcome">Bem-vindo, <span id="showUser"></span> <button id="logoutBtn" onclick="logout()">Sair</button></div>
    <h1>üìù Anota√ß√µes &amp; Desenhos</h1>
    <textarea id="notes" placeholder="Digite suas anota√ß√µes aqui..."></textarea>
    <div class="toolbar">
      <label>Cor:</label>
      <input type="color" id="color" value="#222222">
      <label>Espessura:</label>
      <input type="range" id="size" min="1" max="18" value="4">
      <button type="button" onclick="clearCanvas()">Limpar</button>
      <button type="button" onclick="undoDraw()">Desfazer</button>
    </div>
    <div id="drawWrap">
      <canvas id="draw" width="680" height="300"></canvas>
    </div>
    <div class="actions">
      <button onclick="saveAll()">üíæ Salvar</button>
      <button onclick="loadAll()">üîÑ Restaurar</button>
    </div>
    <p style="text-align:center;color:#888;font-size:0.95em;margin-top:14px;">
      Compat√≠vel com iPadOS antigos ‚Ä¢ Tudo salvo no seu dispositivo por usu√°rio
    </p>
  </div>
  <script>
    // --- Login/Logout ---
    let currentUser = null;
    function showLogin(show) {
      document.getElementById('loginBox').style.display = show?'block':'none';
      document.getElementById('mainApp').style.display = show?'none':'block';
      if(show) document.getElementById('user').focus();
    }
    function saveUsers(users) {
      localStorage.setItem('users', JSON.stringify(users));
    }
    function loadUsers() {
      return JSON.parse(localStorage.getItem('users')||'{}');
    }
    function login() {
      let u = document.getElementById('user').value.trim();
      let p = document.getElementById('pass').value;
      let users = loadUsers();
      if(users[u] && users[u] === p) {
        currentUser = u;
        document.getElementById('showUser').textContent = currentUser;
        showLogin(false);
        loadAll();
        document.getElementById('loginMsg').textContent = '';
      } else {
        document.getElementById('loginMsg').textContent = 'Usu√°rio ou senha incorretos.';
      }
    }
    function register() {
      let u = document.getElementById('user').value.trim();
      let p = document.getElementById('pass').value;
      let users = loadUsers();
      if(u==='' || p==='') {
        document.getElementById('loginMsg').textContent = 'Preencha usu√°rio e senha.';
        return;
      }
      if(users[u]) {
        document.getElementById('loginMsg').textContent = 'Usu√°rio j√° existe.';
      } else {
        users[u] = p;
        saveUsers(users);
        document.getElementById('loginMsg').textContent = 'Usu√°rio registrado! Agora fa√ßa login.';
      }
    }
    function logout() {
      currentUser = null;
      showLogin(true);
      document.getElementById('notes').value = '';
      clearCanvas();
    }
    // --- App por usu√°rio ---
    function userKey(key) {
      return 'user_'+currentUser+'_'+key;
    }
    // Notas
    const notes = document.getElementById('notes');
    notes.oninput = function() {
      if(currentUser) localStorage.setItem(userKey('notes'), notes.value);
    };
    // Canvas desenho
    const canvas = document.getElementById('draw');
    const ctx = canvas.getContext('2d');
    let drawing = false, lastX=0, lastY=0;
    let color = document.getElementById('color').value;
    let size = +document.getElementById('size').value;
    let history = [];
    function resizeCanvas() {
      const wrap = document.getElementById('drawWrap');
      let w = wrap.offsetWidth;
      let h = canvas.height;
      if (window.innerWidth < 650) { h = 180; }
      canvas.width = w;
      canvas.height = h;
      redraw();
    }
    window.addEventListener('resize', resizeCanvas);
    function startDraw(e) {
      if(!currentUser) return;
      drawing = true;
      const pos = getPos(e);
      lastX = pos.x; lastY = pos.y;
      ctx.beginPath(); ctx.moveTo(lastX, lastY);
    }
    function draw(e) {
      if(!drawing) return;
      const pos = getPos(e);
      ctx.lineTo(pos.x, pos.y);
      ctx.strokeStyle = color;
      ctx.lineWidth = size;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.stroke();
      lastX = pos.x; lastY = pos.y;
    }
    function stopDraw() {
      if (drawing) { drawing = false; saveStep(); }
    }
    function getPos(e) {
      let rect = canvas.getBoundingClientRect();
      let x, y;
      if(e.touches) {
        x = e.touches[0].clientX - rect.left;
        y = e.touches[0].clientY - rect.top;
      } else {
        x = e.offsetX;
        y = e.offsetY;
      }
      return {x, y};
    }
    function saveStep() {
      history.push(canvas.toDataURL());
      if(history.length>40) history.shift();
    }
    function redraw() {
      if(!currentUser) return;
      let img = localStorage.getItem(userKey('draw'));
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(img) {
        let image = new window.Image();
        image.onload = () => ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
        image.src = img;
      }
    }
    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('touchstart', startDraw, {passive:false});
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('touchmove', function(e){draw(e); e.preventDefault();}, {passive:false});
    canvas.addEventListener('mouseup', stopDraw);
    canvas.addEventListener('touchend', stopDraw);
    document.getElementById('color').oninput = e => color = e.target.value;
    document.getElementById('size').oninput = e => size = +e.target.value;
    function clearCanvas() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(currentUser) localStorage.removeItem(userKey('draw'));
      history = [];
    }
    function undoDraw() {
      if(history.length) {
        history.pop();
        let last = history[history.length-1];
        ctx.clearRect(0,0,canvas.width,canvas.height);
        if(last) {
          let image = new window.Image();
          image.onload=()=>ctx.drawImage(image,0,0,canvas.width,canvas.height);
          image.src = last;
        }
      }
    }
    function saveAll() {
      if(!currentUser) return;
      localStorage.setItem(userKey('notes'), notes.value);
      localStorage.setItem(userKey('draw'), canvas.toDataURL());
      alert('Salvo com sucesso!');
    }
    function loadAll() {
      if(!currentUser) return;
      notes.value = localStorage.getItem(userKey('notes'))||'';
      redraw();
    }
    // Inicializa√ß√£o
    window.onload = function() {
      let u = localStorage.getItem('lastUser');
      if(u && loadUsers()[u]) {
        currentUser = u;
        document.getElementById('showUser').textContent = currentUser;
        showLogin(false);
        loadAll();
      } else {
        showLogin(true);
      }
      resizeCanvas();
    }
    // Mant√©m usu√°rio logado at√© logout
    window.onbeforeunload = function() {
      if(currentUser) localStorage.setItem('lastUser', currentUser);
    }
  </script>
</body>
</html>
